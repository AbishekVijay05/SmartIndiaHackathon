{% extends "base.html" %}
{% block title %}Wipe Tool - Zero Leaks{% endblock %}
{% block container_class %}container-large{% endblock %}
{% block content %}
<!-- Added professional dashboard elements to the wipe tool page -->
<div class="dashboard-header" style="text-align: center;">
    <h1>Zero Leaks - Secure Data Wiper</h1>
    
</div>

<div class="dashboard-content">
    <div class="wipe-panel">
        <h2>Data Wiping Configuration</h2>
        <form id="wipe-form">
            <div class="form-group">
                <label>Target Type:</label>
                <div class="radio-group">
                    <label><input type="radio" name="wipe_type" value="file" checked> File</label>
                    <label><input type="radio" name="wipe_type" value="folder"> Folder</label>
                    <label><input type="radio" name="wipe_type" value="disk"> Entire Disk (HDD/SSD)</label>
                </div>
            </div>
            <div class="form-group">
                <label for="path-display">Target Path:</label>
                <div class="path-input-group">
                    <input type="text" id="path-display" placeholder="Click Browse to select..." readonly required>
                    <button type="button" id="browse-btn">Browse...</button>
                </div>
            </div>
            <div class="form-group">
                <label for="wipe-method">Wiping Method:</label>
                <select id="wipe-method">
                    <option value="--clear">Clear (1 Pass Zeros - NIST 800-88)</option>
                    <option value="--purge" selected>Purge (3 Pass Overwrite - DoD 5220.22-M)</option>
                    <option value="--destroy-sw">Destroy (7 Pass Overwrite - Software-Based)</option>
                </select>
            </div>
            <button type="submit" id="start-wipe-btn">Start Wipe</button>
        </form>
    </div>
    
    <div class="system-info-panel" >
        <h3>System Information</h3>
        <div class="info-grid" style="border:none; border-radius: 5%; background-color: rgba(198, 198, 198, 0.652);">
            <div class="info-item">
                <span class="info-label">User:</span>
                <span class="info-value">{{ session['username'] }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Session:</span>
                <span class="info-value">Active</span>
            </div>
            <div class="info-item">
                <span class="info-label">Security:</span>
                <span class="info-value">Authenticated</span>
            </div>
        </div>
    </div>
</div>

<div id="status-bar" class="status-bar"></div>
<div style="margin-top: 25px;">
    <label>Log Output:</label>
    <pre id="log-output">Awaiting command...</pre>
</div>
<div id="certificate-links" style="margin-top: 20px; text-align: center;"></div>
<div id="browser-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-path">Browser</h2>
            <button type="button" id="select-folder-btn" style="display:none; width: auto; background-color: #28a745;">Select This Folder</button>
            <span class="close-button">&times;</span>
        </div>
        <div id="modal-browser" class="file-browser"></div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const wipeForm = document.getElementById('wipe-form');
    const statusBar = document.getElementById('status-bar');
    const logOutput = document.getElementById('log-output');
    const pathDisplay = document.getElementById('path-display');
    const startWipeBtn = document.getElementById('start-wipe-btn');
    const certificateLinks = document.getElementById('certificate-links');
    const modal = document.getElementById('browser-modal');
    const browseBtn = document.getElementById('browse-btn');
    const closeBtn = document.querySelector('.close-button');
    const modalBrowser = document.getElementById('modal-browser');
    const modalPath = document.getElementById('modal-path');
    const selectFolderBtn = document.getElementById('select-folder-btn');
    let currentPathInModal = '';
    const getWipeType = () => document.querySelector('input[name="wipe_type"]:checked').value;
    const openModal = () => { modal.style.display = 'flex'; loadBrowser(); };
    const closeModal = () => { modal.style.display = 'none'; };
    browseBtn.onclick = openModal;
    closeBtn.onclick = closeModal;
    window.onclick = (event) => { if (event.target == modal) closeModal(); };
    document.querySelectorAll('input[name="wipe_type"]').forEach(radio => {
        radio.addEventListener('change', () => pathDisplay.value = '');
    });
    selectFolderBtn.onclick = () => {
        pathDisplay.value = currentPathInModal;
        closeModal();
    };
    async function loadBrowser(path = '') {
        const wipeType = getWipeType();
        modalPath.textContent = "Loading...";
        modalBrowser.innerHTML = '<ul><li>Loading...</li></ul>';
        let url = `/browse?type=${wipeType}&path=${encodeURIComponent(path)}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            modalBrowser.innerHTML = '';
            const ul = document.createElement('ul');
            if (data.error) { ul.innerHTML = `<li>Error: ${data.error}</li>`; }
            else if (wipeType === 'disk') {
                selectFolderBtn.style.display = 'none';
                modalPath.textContent = "Select a Physical Disk";
                data.disks.forEach(disk => {
                    const li = document.createElement('li');
                    li.innerHTML = `💾 ${disk.name}`;
                    li.onclick = () => { pathDisplay.value = disk.path; closeModal(); };
                    ul.appendChild(li);
                });
            } else {
                selectFolderBtn.style.display = (wipeType === 'folder' && path) ? 'block' : 'none';
                currentPathInModal = data.current_path;
                modalPath.textContent = data.current_path || 'Select a Drive';
                if (data.parent_path) {
                    const li = document.createElement('li');
                    li.innerHTML = '⬆️ .. (Up)';
                    li.onclick = () => loadBrowser(data.parent_path);
                    ul.appendChild(li);
                }
                const pathSeparator = data.current_path && (data.current_path.includes('\\')) ? '\\' : '/';
                data.folders.forEach(folder => {
                    const li = document.createElement('li');
                    li.innerHTML = `📁 ${folder}`;
                    const newPath = data.current_path ? (data.current_path.endsWith(pathSeparator) ? data.current_path + folder : data.current_path + pathSeparator + folder) : folder;
                    li.onclick = () => loadBrowser(newPath);
                    ul.appendChild(li);
                });
                if (wipeType === 'file') {
                    data.files.forEach(file => {
                        const li = document.createElement('li');
                        li.innerHTML = `📄 ${file}`;
                        const newPath = data.current_path ? (data.current_path.endsWith(pathSeparator) ? data.current_path + file : data.current_path + pathSeparator + file) : file;
                        li.onclick = () => { pathDisplay.value = newPath; closeModal(); };
                        ul.appendChild(li);
                    });
                }
            }
            modalBrowser.appendChild(ul);
        } catch (error) { modalBrowser.innerHTML = `<ul><li>Failed to load file browser.</li></ul>`; }
    }
    wipeForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const wipeType = getWipeType();
        const path = pathDisplay.value;
        const wipeMethod = document.getElementById('wipe-method').value;
        if (!path) { alert('Please select a target to wipe.'); return; }
        let confirmMessage = `Are you sure you want to permanently wipe the ${wipeType} "${path}"? This cannot be undone.`;
        if (wipeType === 'disk') confirmMessage = `EXTREME DANGER! This will wipe the ENTIRE DISK "${path}", destroying ALL data and partitions. Are you absolutely sure?`;
        if (!confirm(confirmMessage)) return;
        logOutput.textContent = 'Wiping in progress... Please wait.';
        statusBar.style.display = 'block';
        statusBar.textContent = 'Data wipe initiated... This may take a long time.';
        statusBar.className = 'status-bar status-success';
        startWipeBtn.disabled = true;
        startWipeBtn.textContent = 'Wiping...';
        certificateLinks.innerHTML = '';
        try {
            const response = await fetch('/wipe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ wipe_type: wipeType, path: path, wipe_method: wipeMethod }),
            });
            const result = await response.json();
            logOutput.textContent = result.log || result.stderr || "No output received.";
            if (result.success) {
                statusBar.textContent = 'Wipe completed successfully device is ready to resuse.';
                statusBar.className = 'status-bar status-success';
                certificateLinks.innerHTML = `<p style="font-weight: bold; font-size: 1.1em;">Download Certificate:</p><a href="/download/${result.certificate_json}" target="_blank" class="btn-download">Download JSON</a> <a href="/download/${result.certificate_pdf}" target="_blank" class="btn-download">Download PDF</a>`;
            } else {
                statusBar.textContent = 'Wipe failed. Check logs for details.';
                statusBar.className = 'status-bar status-error';
            }
        } catch (error) {
            statusBar.textContent = 'An application error occurred.';
            statusBar.className = 'status-bar status-error';
            logOutput.textContent = `Client-side error: ${error}`;
        } finally {
            startWipeBtn.disabled = false;
            startWipeBtn.textContent = 'Start Wipe';
        }
    });
});
</script>
<style>
.dashboard-header {
    margin-bottom: 2rem;
}

.dashboard-stats {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    min-width: 180px;
    flex: 1;
}

.stat-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    font-weight: 500;
}

.dashboard-content {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.wipe-panel {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 2rem;
}

.wipe-panel h2 {
    margin-top: 0;
    margin-bottom: 1.5rem;
    color: var(--primary);
}

.system-info-panel {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 2rem;
}

.system-info-panel h3 {
    margin-top: 0;
    margin-bottom: 1.5rem;
    color: var(--primary);
}

.info-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.info-label {
    font-weight: 600;
    color: var(--text-muted);
}

.info-value {
    font-weight: 500;
    color: var(--text);
}

.btn-download { display: inline-block; padding: 10px 20px; margin: 5px; background-color: var(--success); color: white; text-decoration: none; border-radius: 8px; font-weight: 500; transition: background-color 0.2s ease; }
.btn-download:hover { background-color: #218838; }

@media (max-width: 768px) {
    .dashboard-content {
        grid-template-columns: 1fr;
    }
    
    .dashboard-stats {
        flex-direction: column;
    }
}
</style>
{% endblock %}
